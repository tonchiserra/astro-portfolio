---
import SectionHeading from '@components/ui/SectionHeading.astro';

const [registryRes, weeklyRes, totalRes] = await Promise.all([
  fetch('https://registry.npmjs.org/shopirun'),
  fetch('https://api.npmjs.org/downloads/point/last-week/shopirun'),
  fetch('https://api.npmjs.org/downloads/point/2020-01-01:2030-01-01/shopirun'),
]);
const registry = await registryRes.json();
const weekly = await weeklyRes.json();
const total = await totalRes.json();

const version = registry['dist-tags']?.latest || '1.3.1';
const weeklyDownloads = weekly.downloads ?? 0;
const totalDownloads = total.downloads ?? 0;

const publishedDate = new Date(registry.time?.[version] || Date.now());
const now = new Date();
const diffDays = Math.floor((now.getTime() - publishedDate.getTime()) / (1000 * 60 * 60 * 24));
let lastPublished = '';
if (diffDays === 0) lastPublished = 'today';
else if (diffDays === 1) lastPublished = 'yesterday';
else if (diffDays < 30) lastPublished = `${diffDays} days ago`;
else if (diffDays < 365) lastPublished = `${Math.floor(diffDays / 30)} months ago`;
else lastPublished = `${Math.floor(diffDays / 365)} years ago`;
---

<section id="side-projects" class="py-24 max-w-5xl mx-auto px-6">
  <SectionHeading title="Side Projects" number="04" />

  <div data-animate>
    <a
      href="https://www.npmjs.com/package/shopirun"
      target="_blank"
      rel="noopener noreferrer"
      class="group block p-8 rounded-xl border border-border bg-surface-alt hover:border-accent/30 hover:-translate-y-1.5 hover:shadow-lg hover:shadow-accent/5 transition-all duration-300 max-w-2xl"
    >
      <div class="flex items-start justify-between mb-4">
        <div>
          <div class="flex items-center gap-3 mb-2">
            <h3 class="text-xl font-bold tracking-tight group-hover:text-accent transition-colors">shopirun</h3>
            <span class="text-[11px] px-2.5 py-0.5 rounded-full bg-accent/5 text-accent/70 font-mono">v{version}</span>
          </div>
          <p class="text-sm text-text-muted leading-relaxed">
            A CLI tool to streamline Shopify theme development and deployment workflows. Run commands interactively or directly from the terminal to manage your Shopify themes with ease.
          </p>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-text-muted/40 group-hover:text-accent -translate-x-1 group-hover:translate-x-0 transition-all duration-300 ease-out shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" />
        </svg>
      </div>

      <div class="flex items-center gap-4 mt-5 text-xs text-text-muted">
        <span class="flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
          {totalDownloads.toLocaleString()} total &middot; {weeklyDownloads.toLocaleString()}/week
        </span>
        <span class="flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Last publish {lastPublished}
        </span>
      </div>

      <div class="flex items-center gap-4 mt-4">
        <code class="text-xs bg-surface-alt px-3 py-1.5 rounded-md font-mono text-text-muted">npm i -g shopirun</code>
        <div class="flex flex-wrap gap-1.5">
          <span class="text-[11px] px-2.5 py-0.5 rounded-full bg-accent/5 text-accent/70">Shopify</span>
          <span class="text-[11px] px-2.5 py-0.5 rounded-full bg-accent/5 text-accent/70">Theme development</span>
          <span class="text-[11px] px-2.5 py-0.5 rounded-full bg-accent/5 text-accent/70">npm</span>
          <span class="text-[11px] px-2.5 py-0.5 rounded-full bg-accent/5 text-accent/70">Node.js</span>
        </div>
      </div>
    </a>
  </div>
</section>
